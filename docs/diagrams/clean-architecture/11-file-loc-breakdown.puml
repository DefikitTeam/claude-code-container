@startuml File LOC Breakdown
!include ../_style-common.puml

title Complete File Structure with LOC Estimates

package "src/" <<Folder>> {
  
  package "core/" <<Folder>> #e6f3ff {
    package "entities/" {
      file "user.entity.ts" as E1
      note right: 80 LOC
      file "installation.entity.ts" as E2
      note right: 70 LOC
      file "container-config.entity.ts" as E3
      note right: 90 LOC
      file "deployment.entity.ts" as E4
      note right: 60 LOC
    }
    note right of entities/: **Subtotal: 300 LOC**
    
    package "use-cases/" {
      package "user/" {
        file "register-user.use-case.ts" as UC1
        note right: 120 LOC
        file "update-user.use-case.ts" as UC2
        note right: 80 LOC
        file "delete-user.use-case.ts" as UC3
        note right: 60 LOC
        file "get-user.use-case.ts" as UC4
        note right: 50 LOC
      }
      
      package "github/" {
        file "process-webhook.use-case.ts" as UC5
        note right: 150 LOC
        file "fetch-repositories.use-case.ts" as UC6
        note right: 90 LOC
        file "fetch-branches.use-case.ts" as UC7
        note right: 70 LOC
        file "create-pull-request.use-case.ts" as UC8
        note right: 100 LOC
      }
      
      package "container/" {
        file "spawn-container.use-case.ts" as UC9
        note right: 130 LOC
        file "process-prompt.use-case.ts" as UC10
        note right: 110 LOC
        file "get-logs.use-case.ts" as UC11
        note right: 50 LOC
        file "terminate-container.use-case.ts" as UC12
        note right: 60 LOC
      }
      
      package "deployment/" {
        file "deploy-worker.use-case.ts" as UC13
        note right: 140 LOC
        file "get-status.use-case.ts" as UC14
        note right: 60 LOC
        file "rollback.use-case.ts" as UC15
        note right: 80 LOC
        file "validate-config.use-case.ts" as UC16
        note right: 70 LOC
      }
    }
    note right of use-cases/: **Subtotal: 1,220 LOC**
    
    package "interfaces/" {
      package "repositories/" {
        file "user.repository.ts" as IR1
        note right: 20 LOC
        file "deployment.repository.ts" as IR2
        note right: 20 LOC
      }
      
      package "services/" {
        file "github.service.ts" as IS1
        note right: 25 LOC
        file "token.service.ts" as IS2
        note right: 15 LOC
        file "crypto.service.ts" as IS3
        note right: 15 LOC
        file "container.service.ts" as IS4
        note right: 20 LOC
        file "deployment.service.ts" as IS5
        note right: 15 LOC
      }
    }
    note right of interfaces/: **Subtotal: 130 LOC**
  }
  note bottom of core/: **CORE TOTAL: 1,650 LOC**
  
  package "infrastructure/" <<Folder>> #e6ffe6 {
    package "durable-objects/" {
      file "user-config.do.ts" as DO1
      note right: 350 LOC
      file "github-app-config.do.ts" as DO2
      note right: 300 LOC
      file "acp-session.do.ts" as DO3
      note right: 400 LOC
      file "container.do.ts" as DO4
      note right: 450 LOC
    }
    note right of durable-objects/: **Subtotal: 1,500 LOC**
    
    package "services/" {
      file "github.service.impl.ts" as SVC1
      note right: 280 LOC
      file "token.service.impl.ts" as SVC2
      note right: 200 LOC
      file "crypto.service.impl.ts" as SVC3
      note right: 180 LOC
      file "deployment.service.impl.ts" as SVC4
      note right: 340 LOC
    }
    note right of services/: **Subtotal: 1,000 LOC**
    
    package "repositories/" {
      file "deployment-repository.impl.ts" as REPO1
      note right: 150 LOC
    }
    note right of repositories/: **Subtotal: 150 LOC**
    
    package "adapters/" {
      file "cloudflare-api.adapter.ts" as ADAPT1
      note right: 200 LOC
      file "wrangler.wrapper.ts" as ADAPT2
      note right: 100 LOC
    }
    note right of adapters/: **Subtotal: 300 LOC**
    
    package "external/" {
      file "token-manager.ts" as EXT1
      note right: 500 LOC
    }
    note right of external/: **Subtotal: 500 LOC**
  }
  note bottom of infrastructure/: **INFRASTRUCTURE TOTAL: 3,450 LOC**
  
  package "api/" <<Folder>> #fff4e6 {
    package "controllers/" {
      file "user.controller.ts" as CTRL1
      note right: 150 LOC
      file "github.controller.ts" as CTRL2
      note right: 130 LOC
      file "container.controller.ts" as CTRL3
      note right: 120 LOC
      file "deployment.controller.ts" as CTRL4
      note right: 140 LOC
      file "installation.controller.ts" as CTRL5
      note right: 60 LOC
    }
    note right of controllers/: **Subtotal: 600 LOC**
    
    package "routes/" {
      file "user.routes.ts" as RT1
      note right: 60 LOC
      file "github.routes.ts" as RT2
      note right: 50 LOC
      file "container.routes.ts" as RT3
      note right: 50 LOC
      file "deployment.routes.ts" as RT4
      note right: 70 LOC
      file "installation.routes.ts" as RT5
      note right: 40 LOC
      file "health.routes.ts" as RT6
      note right: 30 LOC
    }
    note right of routes/: **Subtotal: 300 LOC**
    
    package "middleware/" {
      file "auth.middleware.ts" as MW1
      note right: 120 LOC
      file "validation.middleware.ts" as MW2
      note right: 100 LOC
      file "error.middleware.ts" as MW3
      note right: 90 LOC
      file "cors.middleware.ts" as MW4
      note right: 70 LOC
      file "rate-limit.middleware.ts" as MW5
      note right: 90 LOC
    }
    note right of middleware/: **Subtotal: 470 LOC**
    
    package "dto/" {
      file "register-user.dto.ts" as DTO1
      note right: 40 LOC
      file "update-user.dto.ts" as DTO2
      note right: 30 LOC
      file "spawn-container.dto.ts" as DTO3
      note right: 40 LOC
      file "process-prompt.dto.ts" as DTO4
      note right: 40 LOC
      file "deploy-worker.dto.ts" as DTO5
      note right: 50 LOC
      file "webhook-payload.dto.ts" as DTO6
      note right: 60 LOC
      file "create-pr.dto.ts" as DTO7
      note right: 40 LOC
    }
    note right of dto/: **Subtotal: 300 LOC**
    
    package "responses/" {
      file "success.response.ts" as RESP1
      note right: 30 LOC
      file "error.response.ts" as RESP2
      note right: 40 LOC
      file "paginated.response.ts" as RESP3
      note right: 30 LOC
    }
    note right of responses/: **Subtotal: 100 LOC**
  }
  note bottom of api/: **API TOTAL: 1,770 LOC**
  
  package "shared/" <<Folder>> #f3e6ff {
    package "types/" {
      file "index.ts" as TYPE1
      note right: 150 LOC
      file "common.types.ts" as TYPE2
      note right: 50 LOC
    }
    note right of types/: **Subtotal: 200 LOC**
    
    package "errors/" {
      file "base.error.ts" as ERR1
      note right: 50 LOC
      file "validation.error.ts" as ERR2
      note right: 40 LOC
      file "not-found.error.ts" as ERR3
      note right: 30 LOC
      file "unauthorized.error.ts" as ERR4
      note right: 30 LOC
    }
    note right of errors/: **Subtotal: 150 LOC**
    
    package "utils/" {
      file "crypto.util.ts" as UTIL1
      note right: 80 LOC
      file "validation.util.ts" as UTIL2
      note right: 70 LOC
    }
    note right of utils/: **Subtotal: 150 LOC**
  }
  note bottom of shared/: **SHARED TOTAL: 500 LOC**
  
  file "index.ts" as INDEX
  note right: 150 LOC\n(Entry point + DI)
}

note bottom
  **GRAND TOTAL SUMMARY:**
  
  | Layer | Files | LOC | % of Total |
  |-------|-------|-----|------------|
  | Core | 21 | 1,650 | 22% |
  | Infrastructure | 13 | 3,450 | 46% |
  | API | 25 | 1,770 | 24% |
  | Shared | 8 | 500 | 7% |
  | Entry | 1 | 150 | 2% |
  | **TOTAL** | **68** | **7,520** | **100%** |
  
  **Current vs Proposed:**
  - Current: ~15 files, ~7,276 LOC (avg 485 LOC/file)
  - Proposed: ~68 files, ~7,520 LOC (avg 110 LOC/file)
  
  **Benefits:**
  - 4.4x more files = better separation
  - 4.4x smaller files = easier to understand
  - Clear layer boundaries
  - Single Responsibility per file
  - Easy to navigate and maintain
end note

@enduml
