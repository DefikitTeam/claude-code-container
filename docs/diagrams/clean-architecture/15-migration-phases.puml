@startuml Migration Phases
!include ../_style-common.puml

title Refactoring Migration Phases - Incremental Approach

|#f39c12|API Layer|
|#3498db|Core Layer|
|#2ecc71|Infrastructure|
|#9b59b6|Testing|

start

:Current State\n15 files, 7,276 LOC;
note right
  **Starting Point:**
  - Monolithic structure
  - Mixed concerns
  - Low test coverage (~30%)
  - Hard to maintain
end note

partition "**Phase 1: Extract Use Cases** (Week 1-2)" {
  :Create core/use-cases/ structure;
  note right: ~2 days
  
  :Extract User Use Cases\n(register, update, delete, get);
  note right
    **Files Created:**
    - register-user.use-case.ts (120 LOC)
    - update-user.use-case.ts (80 LOC)
    - delete-user.use-case.ts (60 LOC)
    - get-user.use-case.ts (50 LOC)
    
    **Extracted from:**
    - index.ts
    - user-endpoints.ts
    
    **Status:** ✅ API still works
  end note
  
  :Extract GitHub Use Cases\n(webhook, repos, branches, PR);
  note right
    **Files Created:**
    - process-webhook.use-case.ts (150 LOC)
    - fetch-repositories.use-case.ts (90 LOC)
    - fetch-branches.use-case.ts (70 LOC)
    - create-pull-request.use-case.ts (100 LOC)
    
    **Extracted from:**
    - index.ts
    - github-utils.ts
  end note
  
  :Extract Container Use Cases\n(spawn, process, logs, terminate);
  note right
    **Files Created:**
    - spawn-container.use-case.ts (130 LOC)
    - process-prompt.use-case.ts (110 LOC)
    - get-logs.use-case.ts (50 LOC)
    - terminate-container.use-case.ts (60 LOC)
  end note
  
  :Extract Deployment Use Cases\n(deploy, status, rollback);
  note right
    **Files Created:**
    - deploy-worker.use-case.ts (140 LOC)
    - get-status.use-case.ts (60 LOC)
    - rollback.use-case.ts (80 LOC)
    - validate-config.use-case.ts (70 LOC)
  end note
  
  :Update Controllers to use Use Cases;
  note right
    **Modified:**
    - index.ts (now calls use cases)
    - user-endpoints.ts (simplified)
    - deployment-endpoints.ts (simplified)
  end note
  
  :Write Use Case Tests\n(80% coverage);
  note right: ~3 days
  
  :Deploy & Verify;
  note right
    **Verification:**
    - All endpoints still work
    - No breaking changes
    - Tests pass
    - Performance unchanged
  end note
}

:Phase 1 Complete\n✅ Use Cases extracted;
note right
  **Progress:**
  - ~14 new files created
  - ~1,220 LOC in use cases
  - Original files simplified
  - Test coverage: ~50%
end note

partition "**Phase 2: Create Entities & Interfaces** (Week 3)" {
  :Create core/entities/ structure;
  
  :Extract Entities\n(User, Installation, Container, Deployment);
  note right
    **Files Created:**
    - user.entity.ts (80 LOC)
    - installation.entity.ts (70 LOC)
    - container-config.entity.ts (90 LOC)
    - deployment.entity.ts (60 LOC)
    
    **Benefits:**
    - Domain validation centralized
    - Business rules in entities
    - Reusable across use cases
  end note
  
  :Create core/interfaces/ structure;
  
  :Define Repository Interfaces;
  note right
    **Files Created:**
    - user.repository.ts (20 LOC)
    - deployment.repository.ts (20 LOC)
  end note
  
  :Define Service Interfaces;
  note right
    **Files Created:**
    - github.service.ts (25 LOC)
    - token.service.ts (15 LOC)
    - crypto.service.ts (15 LOC)
    - container.service.ts (20 LOC)
    - deployment.service.ts (15 LOC)
  end note
  
  :Update Use Cases to use Entities & Interfaces;
  note right
    **Modified:**
    - All use case files
    - Now depend on interfaces
    - Use entities for domain logic
  end note
  
  :Write Entity Tests;
  note right: ~2 days
  
  :Deploy & Verify;
}

:Phase 2 Complete\n✅ Core layer separated;
note right
  **Progress:**
  - Core layer complete (~1,650 LOC)
  - Clear boundaries defined
  - Interfaces for all dependencies
  - Test coverage: ~60%
end note

partition "**Phase 3: Refactor Infrastructure** (Week 4)" {
  :Create infrastructure/ structure;
  
  :Move Durable Objects to infrastructure/durable-objects/;
  note right
    **Files Moved:**
    - user-config.do.ts
    - github-app-config.do.ts
    - acp-session.do.ts
    - container.do.ts (modified to implement IContainerService)
  end note
  
  :Create Service Implementations;
  note right
    **Files Created:**
    - github.service.impl.ts (280 LOC)
    - token.service.impl.ts (200 LOC)
    - crypto.service.impl.ts (180 LOC)
    - deployment.service.impl.ts (340 LOC)
    
    **Implements:**
    - Core interfaces
    - Infrastructure details
  end note
  
  :Create Repository Implementations;
  note right
    **Files Created:**
    - deployment-repository.impl.ts (150 LOC)
  end note
  
  :Create Adapters\n(Cloudflare API, Wrangler);
  note right
    **Files Created:**
    - cloudflare-api.adapter.ts (200 LOC)
    - wrangler.wrapper.ts (100 LOC)
  end note
  
  :Update Use Cases to use new implementations;
  note right
    **Modified:**
    - Dependency injection in index.ts
    - Use cases receive implementations
  end note
  
  :Write Infrastructure Tests;
  note right: ~2 days
  
  :Deploy & Verify;
}

:Phase 3 Complete\n✅ Infrastructure separated;
note right
  **Progress:**
  - Infrastructure layer complete (~3,450 LOC)
  - Core independent of infrastructure
  - Easy to swap implementations
  - Test coverage: ~70%
end note

partition "**Phase 4: Refactor API Layer** (Week 5)" {
  :Create api/ structure;
  
  :Extract Controllers;
  note right
    **Files Created:**
    - user.controller.ts (150 LOC)
    - github.controller.ts (130 LOC)
    - container.controller.ts (120 LOC)
    - deployment.controller.ts (140 LOC)
    - installation.controller.ts (60 LOC)
    
    **Extracted from:**
    - index.ts
    - user-endpoints.ts
    - deployment-endpoints.ts
    - installation-endpoints.ts
  end note
  
  :Create Modular Routes;
  note right
    **Files Created:**
    - user.routes.ts (60 LOC)
    - github.routes.ts (50 LOC)
    - container.routes.ts (50 LOC)
    - deployment.routes.ts (70 LOC)
    - installation.routes.ts (40 LOC)
    - health.routes.ts (30 LOC)
  end note
  
  :Extract Middleware\n(Auth, Validation, Error, CORS, Rate Limit);
  note right
    **Files Created:**
    - auth.middleware.ts (120 LOC)
    - validation.middleware.ts (100 LOC)
    - error.middleware.ts (90 LOC)
    - cors.middleware.ts (70 LOC)
    - rate-limit.middleware.ts (90 LOC)
  end note
  
  :Create DTOs;
  note right
    **Files Created:**
    - 7 DTO files (~300 LOC total)
    - Input validation
    - Response formatting
  end note
  
  :Create Response Types;
  note right
    **Files Created:**
    - success.response.ts (30 LOC)
    - error.response.ts (40 LOC)
    - paginated.response.ts (30 LOC)
  end note
  
  :Update index.ts\n(Entry point + DI);
  note right
    **Modified:**
    - index.ts now < 150 LOC
    - Only routing and DI
    - Clean and minimal
  end note
  
  :Write API Tests;
  note right: ~2 days
  
  :Deploy & Verify;
}

:Phase 4 Complete\n✅ API layer modular;
note right
  **Progress:**
  - API layer complete (~1,770 LOC)
  - index.ts simplified (150 LOC)
  - Clean separation
  - Test coverage: ~75%
end note

partition "**Phase 5: Shared & Cleanup** (Week 6)" {
  :Create shared/ structure;
  
  :Extract Types;
  note right
    **Files Created:**
    - index.ts (150 LOC)
    - common.types.ts (50 LOC)
  end note
  
  :Create Error Classes;
  note right
    **Files Created:**
    - base.error.ts (50 LOC)
    - validation.error.ts (40 LOC)
    - not-found.error.ts (30 LOC)
    - unauthorized.error.ts (30 LOC)
  end note
  
  :Extract Utils;
  note right
    **Files Created:**
    - crypto.util.ts (80 LOC)
    - validation.util.ts (70 LOC)
  end note
  
  :Delete Old Files\n(index.ts monolith, etc.);
  note right
    **Deleted:**
    - Old endpoint files
    - Unused utilities
    - Duplicate code
  end note
  
  :Update Documentation;
  note right
    **Updated:**
    - README.md
    - Architecture docs
    - API documentation
    - Contributing guide
  end note
  
  :Final Testing\n(Integration + E2E);
  note right: ~3 days
  
  :Performance Testing;
  note right
    **Verify:**
    - No performance regression
    - Response times unchanged
    - Memory usage similar
  end note
  
  :Final Deploy & Monitor;
}

:Refactoring Complete\n✅ Clean Architecture;
note right
  **Final State:**
  - 68 files, ~7,520 LOC
  - Avg 110 LOC/file (was 485)
  - Test coverage: ~80%
  - Clear layer separation
  - Easy to maintain
  - Ready for scale
end note

stop

note bottom
  **Timeline Summary:**
  
  | Phase | Duration | Effort | Risk |
  |-------|----------|--------|------|
  | 1. Extract Use Cases | 2 weeks | High | Low |
  | 2. Entities & Interfaces | 1 week | Medium | Low |
  | 3. Infrastructure | 1 week | Medium | Medium |
  | 4. API Layer | 1 week | High | Low |
  | 5. Shared & Cleanup | 1 week | Low | Low |
  | **Total** | **6 weeks** | **~240h** | **Low** |
  
  **Key Principles:**
  - Incremental changes
  - Deploy after each phase
  - No breaking changes
  - Tests always pass
  - Backward compatible
  
  **Success Metrics:**
  - ✅ All endpoints work
  - ✅ Test coverage 80%+
  - ✅ No performance regression
  - ✅ Code review approved
  - ✅ Documentation updated
end note

@enduml
