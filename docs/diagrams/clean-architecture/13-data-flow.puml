@startuml Data Flow Through Layers
!include ../_style-common.puml

title Request/Response Flow Through Clean Architecture Layers

actor "Client" as Client
participant "Routes" as Routes #f39c12
participant "Middleware" as Middleware #f39c12
participant "Controller" as Controller #f39c12
participant "DTO" as DTO #f39c12
participant "Use Case" as UseCase #3498db
participant "Entity" as Entity #3498db
participant "Repository\nInterface" as IRepo #3498db
participant "Service\nInterface" as IService #3498db
participant "Repository\nImplementation" as RepoImpl #2ecc71
participant "Service\nImplementation" as ServiceImpl #2ecc71
participant "External API" as External #95a5a6

== Inbound Request Flow ==

Client -> Routes: HTTP Request\n(Raw data)
activate Routes
note right: **API Layer Entry**

Routes -> Middleware: Request + Context
activate Middleware

Middleware -> Middleware: Authentication
Middleware -> Middleware: Authorization
Middleware -> Middleware: Rate Limiting

Middleware --> Routes: ✓ Validated
deactivate Middleware

Routes -> Controller: Request + Context
activate Controller

Controller -> DTO: Validate & Parse
activate DTO
DTO -> DTO: Schema validation
DTO -> DTO: Type conversion
DTO -> DTO: Sanitization
DTO --> Controller: Validated DTO
deactivate DTO
note right: **Boundary:\nAPI → Core**

Controller -> UseCase: execute(dto)
activate UseCase
note right: **Core Layer Entry**

UseCase -> UseCase: Business Logic
UseCase -> UseCase: Orchestration

UseCase -> Entity: Create/Update Entity
activate Entity
Entity -> Entity: Domain validation
Entity -> Entity: Business rules
Entity --> UseCase: Valid Entity
deactivate Entity

UseCase -> IRepo: operation(entity)
activate IRepo
note right: **Boundary:\nCore → Infrastructure**

IRepo -> RepoImpl: operation(entity)
activate RepoImpl
RepoImpl -> RepoImpl: Map to storage format
RepoImpl -> RepoImpl: Persist data
RepoImpl --> IRepo: Result
deactivate RepoImpl

IRepo --> UseCase: Result
deactivate IRepo

UseCase -> IService: operation(params)
activate IService

IService -> ServiceImpl: operation(params)
activate ServiceImpl

ServiceImpl -> External: API Call
activate External
External --> ServiceImpl: Response
deactivate External

ServiceImpl --> IService: Result
deactivate ServiceImpl

IService --> UseCase: Result
deactivate IService

UseCase --> Controller: Entity/Result
deactivate UseCase
note right: **Boundary:\nCore → API**

Controller -> Controller: Map Entity to Response DTO
Controller --> Routes: Response DTO
deactivate Controller

Routes -> Routes: Format HTTP Response
Routes --> Client: HTTP Response\n(JSON)
deactivate Routes

== Layer Responsibilities ==

note over Routes, Middleware
  **API Layer:**
  - HTTP handling
  - Input validation
  - Authentication/Authorization
  - Response formatting
  - Error handling
end note

note over Controller, DTO
  **API Layer (Controllers):**
  - Request parsing
  - DTO validation
  - Use case invocation
  - Response mapping
end note

note over UseCase, Entity
  **Core Layer:**
  - Business logic
  - Use case orchestration
  - Domain validation
  - Entity management
  - Interface definitions
end note

note over IRepo, IService
  **Core Layer (Interfaces):**
  - Repository contracts
  - Service contracts
  - No implementation details
  - Framework agnostic
end note

note over RepoImpl, ServiceImpl
  **Infrastructure Layer:**
  - Interface implementations
  - Database access
  - External API calls
  - Framework-specific code
  - Technical details
end note

== Data Transformation ==

note as N1
  **Data Flow & Transformation:**
  
  1. **Client → API:**
     Raw HTTP → Request object
  
  2. **API → Core:**
     Request → DTO → Domain Entity
  
  3. **Core → Infrastructure:**
     Entity → Storage model/API params
  
  4. **Infrastructure → External:**
     API params → External format
  
  5. **Return path (reverse):**
     External → Storage → Entity → DTO → Response
  
  **Key Points:**
  - Each layer has its own data structures
  - Transformations happen at boundaries
  - Core knows nothing about HTTP or storage
  - Infrastructure knows nothing about business rules
end note

@enduml
