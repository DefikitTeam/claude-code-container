@startuml Dependency Graph
!include ../_style-common.puml

title Inter-Module Dependencies

' Define modules with colors
package "Core Layer" <<Rectangle>> #3498db {
  [User Module\nEntities & Use Cases] as UserCore
  [GitHub Module\nEntities & Use Cases] as GitHubCore
  [Container Module\nEntities & Use Cases] as ContainerCore
  [Deployment Module\nEntities & Use Cases] as DeployCore
  [Interfaces\n(Repositories & Services)] as Interfaces
}

package "API Layer" <<Rectangle>> #f39c12 {
  [User API\n(Routes, Controllers)] as UserAPI
  [GitHub API\n(Routes, Controllers)] as GitHubAPI
  [Container API\n(Routes, Controllers)] as ContainerAPI
  [Deployment API\n(Routes, Controllers)] as DeployAPI
  [Middleware\n(Auth, Validation, etc.)] as Middleware
}

package "Infrastructure Layer" <<Rectangle>> #2ecc71 {
  [User Repository\n(UserConfigDO)] as UserInfra
  [GitHub Service\n(GitHubServiceImpl)] as GitHubInfra
  [Container Service\n(ContainerDO)] as ContainerInfra
  [Deployment Service\n(DeploymentServiceImpl)] as DeployInfra
  [Token Manager] as TokenMgr
  [Crypto Service] as CryptoInfra
}

package "Shared" <<Rectangle>> #9b59b6 {
  [Types] as Types
  [Errors] as Errors
  [Utils] as Utils
}

package "External" <<Cloud>> #95a5a6 {
  [GitHub API] as GitHubExt
  [Anthropic API] as AnthropicExt
  [Cloudflare API] as CloudflareExt
}

' API Layer depends on Core Layer
UserAPI --> UserCore : uses
GitHubAPI --> GitHubCore : uses
ContainerAPI --> ContainerCore : uses
DeployAPI --> DeployCore : uses

' API Layer uses Middleware
UserAPI ..> Middleware : uses
GitHubAPI ..> Middleware : uses
ContainerAPI ..> Middleware : uses
DeployAPI ..> Middleware : uses

' Core Layer depends on Interfaces
UserCore --> Interfaces : depends on
GitHubCore --> Interfaces : depends on
ContainerCore --> Interfaces : depends on
DeployCore --> Interfaces : depends on

' Infrastructure implements Interfaces
UserInfra ..|> Interfaces : implements
GitHubInfra ..|> Interfaces : implements
ContainerInfra ..|> Interfaces : implements
DeployInfra ..|> Interfaces : implements
TokenMgr ..|> Interfaces : implements
CryptoInfra ..|> Interfaces : implements

' Cross-module dependencies in Core
GitHubCore --> UserCore : uses UserEntity
ContainerCore --> UserCore : uses UserEntity
ContainerCore --> GitHubCore : uses InstallationEntity
DeployCore --> UserCore : uses UserEntity

' Infrastructure dependencies
GitHubInfra --> TokenMgr : uses
DeployInfra --> GitHubInfra : uses
ContainerInfra --> UserInfra : uses
ContainerInfra --> CryptoInfra : uses

' External dependencies
GitHubInfra --> GitHubExt : calls
ContainerInfra --> AnthropicExt : calls
DeployInfra --> CloudflareExt : calls

' Shared dependencies
UserCore ..> Types : uses
GitHubCore ..> Types : uses
ContainerCore ..> Types : uses
DeployCore ..> Types : uses
UserAPI ..> Errors : throws
GitHubAPI ..> Errors : throws
ContainerAPI ..> Errors : throws
DeployAPI ..> Errors : throws
Middleware ..> Utils : uses
CryptoInfra ..> Utils : uses

note right of Interfaces
  **Dependency Inversion:**
  
  Core defines interfaces.
  Infrastructure implements them.
  
  This allows:
  - Core to be tested independently
  - Infrastructure to be swapped
  - No circular dependencies
end note

note bottom of UserCore
  **Module Coupling:**
  
  | Module | Depends On |
  |--------|-----------|
  | User | None |
  | GitHub | User |
  | Container | User, GitHub |
  | Deployment | User |
  
  Low coupling = Easy to change
end note

note as N1
  **Dependency Flow:**
  
  API → Core → Interfaces ← Infrastructure → External
  
  Dependencies flow INWARD to Core.
  No cyclic dependencies.
  Clean separation of concerns.
end note

@enduml
