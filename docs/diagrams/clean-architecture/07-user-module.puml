@startuml User Module Design
!include ../_style-common.puml

title User Module - Complete Flow

actor "Client" as Client
participant "UserRoutes" as Routes #f39c12
participant "AuthMiddleware" as Auth #f39c12
participant "ValidationMiddleware" as Validation #f39c12
participant "UserController" as Controller #f39c12
participant "RegisterUserUseCase" as UseCase #3498db
participant "UserEntity" as Entity #3498db
participant "IUserRepository" as IRepo #3498db
participant "IGitHubService" as IGitHub #3498db
participant "ICryptoService" as ICrypto #3498db
participant "UserConfigDO" as DO #2ecc71
participant "GitHubServiceImpl" as GitHub #2ecc71
participant "CryptoServiceImpl" as Crypto #2ecc71

== User Registration Flow ==

Client -> Routes: POST /user/register\n{"userId": "...", "installationId": "...", "anthropicApiKey": "..."}
activate Routes

Routes -> Auth: validate(context)
activate Auth
Auth --> Routes: ✓ Valid
deactivate Auth

Routes -> Validation: validateBody(RegisterUserDto)
activate Validation
Validation -> Validation: Check required fields
Validation -> Validation: Validate formats
Validation --> Routes: ✓ Valid
deactivate Validation

Routes -> Controller: register(context)
activate Controller

Controller -> Controller: Parse RegisterUserDto from request
Controller -> UseCase: execute(dto)
activate UseCase

UseCase -> IGitHub: validateInstallation(installationId)
activate IGitHub
IGitHub -> GitHub: validateInstallation(installationId)
activate GitHub
GitHub -> GitHub: Call GitHub API\nGET /app/installations/{id}
GitHub --> IGitHub: Installation valid
deactivate GitHub
IGitHub --> UseCase: true
deactivate IGitHub

UseCase -> ICrypto: encrypt(anthropicApiKey)
activate ICrypto
ICrypto -> Crypto: encrypt(anthropicApiKey)
activate Crypto
Crypto -> Crypto: AES-256-GCM encryption
Crypto --> ICrypto: encrypted key
deactivate Crypto
ICrypto --> UseCase: encrypted key
deactivate ICrypto

UseCase -> Entity: new UserEntity(data)
activate Entity
Entity -> Entity: validate()
Entity --> UseCase: UserEntity instance
deactivate Entity

UseCase -> IRepo: save(userEntity)
activate IRepo
IRepo -> DO: save(userEntity)
activate DO
DO -> DO: Encrypt sensitive data
DO -> DO: Store in Durable Object storage
DO --> IRepo: void
deactivate DO
IRepo --> UseCase: void
deactivate IRepo

UseCase --> Controller: UserEntity
deactivate UseCase

Controller -> Controller: Map to response DTO
Controller --> Routes: Response 201\n{"success": true, "data": {...}}
deactivate Controller

Routes --> Client: HTTP 201 Created
deactivate Routes

note over Client, Crypto
  **User Module Summary:**
  
  **Files Structure:**
  • Routes: user.routes.ts (~60 LOC)
  • Controller: user.controller.ts (~150 LOC)
  • Use Cases: 4 files (~310 LOC)
    - register-user.use-case.ts
    - update-user.use-case.ts
    - delete-user.use-case.ts
    - get-user.use-case.ts
  • Entity: user.entity.ts (~80 LOC)
  • DTOs: 3 files (~110 LOC)
  • Repository: user-config.do.ts (~350 LOC)
  
  **Total: ~1,060 LOC**
  
  **Benefits:**
  ✓ Clear separation of concerns
  ✓ Single responsibility per file
  ✓ Easy to test (mock interfaces)
  ✓ Business logic isolated from infrastructure
end note

@enduml
