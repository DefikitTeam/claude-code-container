@startuml Core Layer Design
!include ../_style-common.puml

title Core Layer - Entities, Use Cases, and Interfaces

package "core/" <<Folder>> #3498db {
  
  package "entities/" <<Folder>> {
    class UserEntity {
      +id: string
      +userId: string
      +installationId: string
      +anthropicApiKey: string
      +metadata: Record<string, any>
      +createdAt: Date
      +updatedAt: Date
      --
      +validate(): ValidationResult
      +isActive(): boolean
      +canAccessRepository(repoId): boolean
    }
    note right: ~80 LOC
    
    class InstallationEntity {
      +id: string
      +installationId: string
      +accountId: string
      +accountType: string
      +permissions: Permissions
      +repositories: string[]
      +createdAt: Date
      --
      +hasPermission(perm): boolean
      +canAccessRepo(repo): boolean
    }
    note right: ~70 LOC
    
    class ContainerConfigEntity {
      +id: string
      +userId: string
      +installationId: string
      +repositoryUrl: string
      +branch: string
      +containerImage: string
      +environmentVars: Record<string, string>
      --
      +validate(): ValidationResult
      +toContainerPayload(): ContainerPayload
    }
    note right: ~90 LOC
    
    class DeploymentEntity {
      +id: string
      +userId: string
      +containerConfigId: string
      +status: DeploymentStatus
      +logs: string[]
      +startedAt: Date
      +completedAt?: Date
      --
      +markAsRunning(): void
      +markAsCompleted(result): void
      +markAsFailed(error): void
      +getDuration(): number
    }
    note right: ~60 LOC
  }
  
  package "use-cases/" <<Folder>> {
    
    package "user/" <<Folder>> {
      class RegisterUserUseCase {
        -userRepo: IUserRepository
        -githubService: IGitHubService
        -cryptoService: ICryptoService
        --
        +execute(dto: RegisterUserDto): Promise<UserEntity>
        -validateInstallation(id): Promise<void>
        -encryptApiKey(key): Promise<string>
      }
      note right: ~120 LOC
      
      class UpdateUserUseCase {
        -userRepo: IUserRepository
        -cryptoService: ICryptoService
        --
        +execute(id, dto): Promise<UserEntity>
        -validateUpdate(user, dto): void
      }
      note right: ~80 LOC
      
      class DeleteUserUseCase {
        -userRepo: IUserRepository
        -containerService: IContainerService
        --
        +execute(id): Promise<void>
        -cleanupContainers(userId): Promise<void>
      }
      note right: ~60 LOC
      
      class GetUserUseCase {
        -userRepo: IUserRepository
        --
        +execute(id): Promise<UserEntity>
        +executeByInstallation(installationId): Promise<UserEntity>
      }
      note right: ~50 LOC
    }
    
    package "github/" <<Folder>> {
      class ProcessWebhookUseCase {
        -userRepo: IUserRepository
        -containerService: IContainerService
        -githubService: IGitHubService
        --
        +execute(payload: WebhookPayload): Promise<void>
        -validateSignature(payload): Promise<boolean>
        -routeEvent(event): Promise<void>
      }
      note right: ~150 LOC
      
      class FetchRepositoriesUseCase {
        -githubService: IGitHubService
        -tokenService: ITokenService
        --
        +execute(installationId): Promise<Repository[]>
        -refreshTokenIfNeeded(token): Promise<string>
      }
      note right: ~90 LOC
      
      class CreatePullRequestUseCase {
        -githubService: IGitHubService
        -userRepo: IUserRepository
        --
        +execute(dto: CreatePRDto): Promise<PullRequest>
        -validatePermissions(userId, repo): Promise<void>
      }
      note right: ~100 LOC
    }
    
    package "container/" <<Folder>> {
      class SpawnContainerUseCase {
        -containerService: IContainerService
        -userRepo: IUserRepository
        -deploymentRepo: IDeploymentRepository
        --
        +execute(dto: SpawnDto): Promise<DeploymentEntity>
        -validateConfig(config): Promise<void>
        -prepareEnvironment(config): Promise<EnvVars>
      }
      note right: ~130 LOC
      
      class ProcessPromptUseCase {
        -containerService: IContainerService
        -userRepo: IUserRepository
        -githubService: IGitHubService
        --
        +execute(dto: PromptDto): Promise<ProcessResult>
        -createIssue(result): Promise<string>
      }
      note right: ~110 LOC
    }
    
    package "deployment/" <<Folder>> {
      class DeployWorkerUseCase {
        -deploymentService: IDeploymentService
        -userRepo: IUserRepository
        --
        +execute(dto: DeployDto): Promise<DeploymentResult>
        -validateDeploymentConfig(config): Promise<void>
        -prepareSecrets(secrets): Promise<Record<string, string>>
      }
      note right: ~140 LOC
    }
  }
  
  package "interfaces/" <<Folder>> {
    
    package "repositories/" <<Folder>> {
      interface IUserRepository {
        +save(user: UserEntity): Promise<void>
        +findById(id: string): Promise<UserEntity | null>
        +findByInstallationId(id: string): Promise<UserEntity | null>
        +findAll(): Promise<UserEntity[]>
        +delete(id: string): Promise<void>
      }
      note right: ~20 LOC
      
      interface IDeploymentRepository {
        +save(deployment: DeploymentEntity): Promise<void>
        +findById(id: string): Promise<DeploymentEntity | null>
        +findByUserId(userId: string): Promise<DeploymentEntity[]>
        +update(id: string, updates: Partial<DeploymentEntity>): Promise<void>
      }
      note right: ~20 LOC
    }
    
    package "services/" <<Folder>> {
      interface IGitHubService {
        +validateInstallation(id: string): Promise<boolean>
        +getRepositories(installationId: string): Promise<Repository[]>
        +getBranches(owner: string, repo: string): Promise<Branch[]>
        +createPullRequest(dto: CreatePRDto): Promise<PullRequest>
        +createIssue(dto: CreateIssueDto): Promise<Issue>
      }
      note right: ~25 LOC
      
      interface ITokenService {
        +getInstallationToken(id: string): Promise<string>
        +refreshToken(id: string): Promise<string>
        +validateToken(token: string): Promise<boolean>
      }
      note right: ~15 LOC
      
      interface ICryptoService {
        +encrypt(data: string): Promise<string>
        +decrypt(encrypted: string): Promise<string>
        +hash(data: string): Promise<string>
      }
      note right: ~15 LOC
      
      interface IContainerService {
        +spawn(config: ContainerConfig): Promise<string>
        +execute(id: string, command: string): Promise<ExecutionResult>
        +getLogs(id: string): Promise<string[]>
        +terminate(id: string): Promise<void>
      }
      note right: ~20 LOC
      
      interface IDeploymentService {
        +deploy(config: DeploymentConfig): Promise<DeploymentResult>
        +getStatus(deploymentId: string): Promise<DeploymentStatus>
        +rollback(deploymentId: string): Promise<void>
      }
      note right: ~15 LOC
    }
  }
}

note bottom
  **Core Layer Summary:**
  - Total: ~1,200 LOC
  - Entities: ~300 LOC (4 files)
  - Use Cases: ~900 LOC (10 files)
  - Interfaces: ~130 LOC (7 files)
  
  **Characteristics:**
  - No external dependencies
  - Pure TypeScript
  - Business logic only
  - Framework agnostic
  - Highly testable
end note

@enduml
