@startuml Container Module Design
!include ../_style-common.puml

title Container Module - Spawn & Processing

actor "Client" as Client
participant "ContainerRoutes" as Routes #f39c12
participant "AuthMiddleware" as Auth #f39c12
participant "ContainerController" as Controller #f39c12
participant "SpawnContainerUseCase" as SpawnUC #3498db
participant "ProcessPromptUseCase" as PromptUC #3498db
participant "ContainerConfigEntity" as ConfigEntity #3498db
participant "DeploymentEntity" as DeployEntity #3498db
participant "IContainerService" as IContainer #3498db
participant "IUserRepository" as IUserRepo #3498db
participant "IGitHubService" as IGitHub #3498db
participant "IDeploymentRepository" as IDeployRepo #3498db
participant "ContainerDO" as ContainerDO #2ecc71
participant "UserConfigDO" as UserDO #2ecc71
participant "DeploymentRepoDO" as DeployDO #2ecc71

== Spawn Container Flow ==

Client -> Routes: POST /container/spawn\n{"userId": "...", "repositoryUrl": "...", "branch": "..."}
activate Routes

Routes -> Auth: validate(context)
activate Auth
Auth --> Routes: ✓ Valid
deactivate Auth

Routes -> Controller: spawn(context)
activate Controller

Controller -> SpawnUC: execute(dto)
activate SpawnUC

SpawnUC -> IUserRepo: findById(userId)
activate IUserRepo
IUserRepo -> UserDO: findById(userId)
activate UserDO
UserDO --> IUserRepo: UserEntity
deactivate UserDO
IUserRepo --> SpawnUC: UserEntity
deactivate IUserRepo

SpawnUC -> IGitHub: validateRepository(repoUrl, installationId)
activate IGitHub
IGitHub --> SpawnUC: ✓ Valid
deactivate IGitHub

SpawnUC -> ConfigEntity: new ContainerConfigEntity(data)
activate ConfigEntity
ConfigEntity -> ConfigEntity: validate()
ConfigEntity --> SpawnUC: ConfigEntity
deactivate ConfigEntity

SpawnUC -> DeployEntity: new DeploymentEntity()
activate DeployEntity
DeployEntity -> DeployEntity: Set status = PENDING
DeployEntity --> SpawnUC: DeploymentEntity
deactivate DeployEntity

SpawnUC -> IDeployRepo: save(deployment)
activate IDeployRepo
IDeployRepo -> DeployDO: save(deployment)
activate DeployDO
DeployDO --> IDeployRepo: void
deactivate DeployDO
IDeployRepo --> SpawnUC: void
deactivate IDeployRepo

SpawnUC -> IContainer: spawn(config)
activate IContainer
IContainer -> ContainerDO: spawn(config)
activate ContainerDO

ContainerDO -> ContainerDO: Get Durable Object instance
ContainerDO -> ContainerDO: Prepare environment variables\n(ANTHROPIC_API_KEY, GITHUB_TOKEN, etc.)

ContainerDO -> ContainerDO: Create Cloudflare Container\nwith specified image

ContainerDO -> ContainerDO: Mount workspace volume\n(/tmp/workspaces/{uuid})

ContainerDO -> ContainerDO: Start container process\nwith HTTP bridge

ContainerDO --> IContainer: containerId
deactivate ContainerDO
IContainer --> SpawnUC: containerId
deactivate IContainer

SpawnUC -> IDeployRepo: update(deploymentId, {status: RUNNING})
activate IDeployRepo
IDeployRepo -> DeployDO: update(deploymentId, {status: RUNNING})
activate DeployDO
DeployDO --> IDeployRepo: void
deactivate DeployDO
IDeployRepo --> SpawnUC: void
deactivate IDeployRepo

SpawnUC --> Controller: DeploymentEntity
deactivate SpawnUC

Controller --> Routes: Response 201\n{"success": true, "data": {"deploymentId": "...", "containerId": "..."}}
deactivate Controller

Routes --> Client: HTTP 201 Created
deactivate Routes

== Process Prompt Flow ==

Client -> Routes: POST /container/process\n{"userId": "...", "prompt": "...", "repositoryUrl": "..."}
activate Routes

Routes -> Controller: processPrompt(context)
activate Controller

Controller -> PromptUC: execute(dto)
activate PromptUC

PromptUC -> IUserRepo: findById(userId)
activate IUserRepo
IUserRepo -> UserDO: findById(userId)
activate UserDO
UserDO --> IUserRepo: UserEntity
deactivate UserDO
IUserRepo --> PromptUC: UserEntity
deactivate IUserRepo

PromptUC -> IContainer: spawn(config)
activate IContainer
IContainer -> ContainerDO: spawn(config)
activate ContainerDO
ContainerDO --> IContainer: containerId
deactivate ContainerDO
IContainer --> PromptUC: containerId
deactivate IContainer

PromptUC -> IContainer: execute(containerId, prompt)
activate IContainer
IContainer -> ContainerDO: execute(command)
activate ContainerDO

ContainerDO -> ContainerDO: Send HTTP request to container\nPOST /process\n{"type": "prompt", "payload": {...}}

ContainerDO -> ContainerDO: Wait for processing\n(Claude Code SDK execution)

ContainerDO -> ContainerDO: Collect logs and results

ContainerDO --> IContainer: ExecutionResult\n{success: true, pullRequestUrl: "...", logs: [...]}
deactivate ContainerDO
IContainer --> PromptUC: ExecutionResult
deactivate IContainer

alt Create Issue if requested
  PromptUC -> IGitHub: createIssue(result)
  activate IGitHub
  IGitHub --> PromptUC: Issue URL
  deactivate IGitHub
end

PromptUC -> IContainer: terminate(containerId)
activate IContainer
IContainer -> ContainerDO: terminate()
activate ContainerDO
ContainerDO -> ContainerDO: Stop container
ContainerDO -> ContainerDO: Cleanup workspace
ContainerDO --> IContainer: void
deactivate ContainerDO
IContainer --> PromptUC: void
deactivate IContainer

PromptUC --> Controller: ProcessResult
deactivate PromptUC

Controller --> Routes: Response 200\n{"success": true, "data": {...}}
deactivate Controller

Routes --> Client: HTTP 200 OK
deactivate Routes

note over Client, DeployDO
  **Container Module Summary**
  
  **Files Structure:**
  • container.routes.ts (~50 LOC)
  • container.controller.ts (~120 LOC)
  • Use Cases (~350 LOC):
    - spawn-container.use-case.ts (130 LOC)
    - process-prompt.use-case.ts (110 LOC)
    - get-logs.use-case.ts (50 LOC)
    - terminate-container.use-case.ts (60 LOC)
  • Entities (~150 LOC)
  • DTOs (~110 LOC)
  • container.do.ts (~450 LOC)
  • Container Scripts (~1,079 LOC)
  **Total: ~2,309 LOC**
  
  **Key Features:**
  ✓ Dynamic container spawning
  ✓ Environment preparation
  ✓ HTTP bridge communication
  ✓ Log collection & cleanup
end note

@enduml
