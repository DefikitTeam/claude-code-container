import { ValidationError } from '../../../shared/errors/validation.error';
import { IGitHubService } from '../../interfaces/services/github.service';
import type { AcpSession } from '../../../infrastructure/durable-objects/acp-session.do';

export interface CreatePRFromSessionDto {
  sessionId: string;
  userId: string;
  installationId: string;
  title?: string;
  description?: string;
}

export interface CreatePRFromSessionResult {
  success: boolean;
  pullRequestNumber: number;
  pullRequestUrl: string;
  workingBranch: string;
  baseBranch: string;
  commitsCount: number;
}

/**
 * Create PR From Session Use Case
 * Creates a GitHub Pull Request from the session's working branch
 */
export class CreatePRFromSessionUseCase {
  constructor(
    private readonly githubService: IGitHubService,
    private readonly env: Env,
  ) {}

  async execute(
    dto: CreatePRFromSessionDto,
  ): Promise<CreatePRFromSessionResult> {
    // Validate input
    if (!dto.sessionId) {
      throw new ValidationError('sessionId is required');
    }

    // Get session from Durable Object
    const sessionDO = this.env.ACP_SESSION.idFromName(dto.sessionId);
    const sessionStub = this.env.ACP_SESSION.get(sessionDO);
    const sessionResponse = await sessionStub.fetch(
      `http://do/session?sessionId=${dto.sessionId}`,
    );

    if (!sessionResponse.ok) {
      throw new Error('Session not found');
    }

    const session = await sessionResponse.json<AcpSession>();

    // Validate coding mode and working branch
    if (!session.codingModeEnabled || !session.workingBranch) {
      throw new ValidationError(
        'Session does not have a working branch to create PR from',
      );
    }

    if (session.branchStatus === 'pr_created') {
      throw new ValidationError(
        `PR already created for this session: ${session.pullRequestUrl}`,
      );
    }

    if (!session.selectedRepository || !session.selectedBranch) {
      throw new ValidationError(
        'Session repository configuration is incomplete',
      );
    }

    if ((session.totalCommits || 0) === 0) {
      throw new ValidationError(
        'No commits found on working branch to create PR',
      );
    }

    // Extract repository owner and name
    const [owner, repo] = session.selectedRepository.split('/');
    if (!owner || !repo) {
      throw new ValidationError('Invalid repository format');
    }

    // Generate PR title and description
    const title =
      dto.title || `AI Coding Session: ${session.totalCommits} changes`;
    const description =
      dto.description ||
      this.generatePRDescription(
        session.workingBranch,
        session.totalCommits || 0,
        session.lastCommitSha,
      );

    // Create Pull Request via GitHub Service
    const pr = await this.githubService.createPullRequest({
      owner,
      repo,
      head: session.workingBranch,
      base: session.selectedBranch,
      title,
      body: description,
      installationId: dto.installationId,
    });

    // Update session PR tracking
    const updateResponse = await sessionStub.fetch(
      'http://do/session/pr-tracking',
      {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sessionId: dto.sessionId,
          pullRequestNumber: pr.number,
          pullRequestUrl: pr.url,
        }),
      },
    );

    if (!updateResponse.ok) {
      console.error('Failed to update PR tracking in session');
    }

    return {
      success: true,
      pullRequestNumber: pr.number,
      pullRequestUrl: pr.url,
      workingBranch: session.workingBranch,
      baseBranch: session.selectedBranch,
      commitsCount: session.totalCommits || 0,
    };
  }

  private generatePRDescription(
    workingBranch: string,
    totalCommits: number,
    lastCommitSha?: string,
  ): string {
    return `## ðŸ¤– AI Coding Session

This PR contains ${totalCommits} automated code change${totalCommits > 1 ? 's' : ''} from an AI coding session.

**Working Branch**: \`${workingBranch}\`
${lastCommitSha ? `**Latest Commit**: \`${lastCommitSha.substring(0, 7)}\`` : ''}

### Changes Summary
- ${totalCommits} commit${totalCommits > 1 ? 's' : ''} containing automated code improvements

Please review the commits for details on the specific changes made.

---
*Generated by LumiLink AI Code Mode*
`;
  }
}
